# =============================
# 99-ocserv-tune.conf
# AnyConnect (TLS-only) + iptables relay —— 高峰稳压 / 稳连优化
# =============================

############################################
# 1) 拥塞控制 & 队列（强烈推荐）
############################################
net.core.default_qdisc = fq               # 配合 BBR 更平滑
net.ipv4.tcp_congestion_control = bbr     # 跨境/高 RTT 稳定性明显更好

############################################
# 2) Socket 缓冲区与队列（兼顾高并发）
############################################
net.core.rmem_max = 67108848              # ~64MB
net.core.wmem_max = 67108848
net.core.somaxconn = 4096                 # listen backlog 上限
net.ipv4.tcp_max_syn_backlog = 4096       # 半连接队列上限
net.ipv4.tcp_rmem = 16384 16777216 536870912
net.ipv4.tcp_wmem = 16384 16777216 536870912
net.ipv4.tcp_adv_win_scale = -2           # 保守窗口，降排队风险

############################################
# 3) TCP 功能（丢包/高 RTT 友好）
############################################
net.ipv4.tcp_sack = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_mtu_probing = 1              # 避免 PMTU 黑洞
net.ipv4.tcp_base_mss = 1024              # 保守 MSS，配合边界 TCPMSS 更稳

############################################
# 4) Keepalive（防 NAT/中间设备回收）
############################################
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

############################################
# 5) 连接追踪（conntrack）——后端 & 中继都要开
############################################
net.netfilter.nf_conntrack_max = 262144
net.netfilter.nf_conntrack_tcp_timeout_established = 7200
net.netfilter.nf_conntrack_generic_timeout = 120
net.netfilter.nf_conntrack_udp_timeout = 120
net.netfilter.nf_conntrack_udp_timeout_stream = 300

############################################
# 6) 本地 UNIX 套接字队列（稳住 sec-mod IPC）
############################################
net.unix.max_dgram_qlen = 1024

############################################
# 7) 路由 / 转发（VPN/relay 必需）
############################################
net.ipv4.ip_forward = 1

############################################
# 8) 系统稳定性
############################################
kernel.panic = -1
vm.swappiness = 0

############################################
# 9) ICMP / PMTUD 安全项
############################################
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
