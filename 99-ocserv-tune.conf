# ===============================================
# 长城中继网络优化配置 v1.0
# 作者：Rick
# 说明：适用于 AnyConnect / V2Ray / HAProxy 等 VPN 中继
# 目标：高峰稳定转发、防断流、防 NAT 回收、保守安全
# ===============================================

########## 一、系统资源 ##########
fs.file-max = 1000000
fs.inotify.max_user_instances = 65536
kernel.panic = -1
vm.swappiness = 0

########## 二、IP 转发 ##########
net.ipv4.conf.all.route_localnet = 1
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv4.conf.default.forwarding = 1

########## 三、IPv6 支持（如未用可禁用） ##########
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1
net.ipv6.conf.lo.forwarding = 1
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0

########## 四、TCP 基础 ##########
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_fack = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2
net.ipv4.tcp_moderate_rcvbuf = 1

########## 五、TCP 重传与保活 ##########
# 防止短时丢包导致误断线
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_retries2 = 12
net.ipv4.tcp_orphan_retries = 7
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 3

# NAT 保活（VPN 关键）
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

########## 六、TIME_WAIT 与 FIN ##########
net.ipv4.tcp_tw_reuse = 1
# tcp_tw_recycle 已废弃，禁止使用
net.ipv4.tcp_fin_timeout = 30

########## 七、MTU / 黑洞检测 ##########
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_rfc1337 = 1

########## 八、缓冲区与性能 ##########
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 16384 16777216 536870912
net.ipv4.tcp_wmem = 16384 16777216 536870912
net.ipv4.tcp_max_syn_backlog = 131072
net.core.netdev_max_backlog = 131072
net.core.somaxconn = 32768

########## 九、连接追踪与 NAT ##########
net.netfilter.nf_conntrack_max = 262144
net.netfilter.nf_conntrack_buckets = 65536
net.netfilter.nf_conntrack_tcp_timeout_established = 7200
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 60
net.netfilter.nf_conntrack_generic_timeout = 120
net.netfilter.nf_conntrack_udp_timeout = 120
net.netfilter.nf_conntrack_udp_timeout_stream = 300

########## 十、ICMP 与安全 ##########
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.ping_group_range = 0 2147483647

########## 十一、UNIX 套接字队列 ##########
net.unix.max_dgram_qlen = 1024
